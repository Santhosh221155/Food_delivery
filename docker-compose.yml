version: '3.9'

services:
  # =====================================================
  # MongoDB Database
  # =====================================================
  mongodb:
    image: mongo:7.0
    container_name: fooddelivery-mongodb
    ports:
      - "27017:27017"
    environment:
      MONGO_INITDB_ROOT_USERNAME: santhosh_db_user
      MONGO_INITDB_ROOT_PASSWORD: san221155
      MONGO_INITDB_DATABASE: fooddelivery_prod
    volumes:
      - mongodb_data:/data/db
    networks:
      - fooddelivery-network
    healthcheck:
      test: echo 'db.runCommand("ping").ok' | mongosh localhost/test --quiet
      interval: 10s
      timeout: 5s
      retries: 5

  # =====================================================
  # Python FastAPI Backend Instances (2 replicas)
  # =====================================================
  python-api-1:
    build:
      context: ./backend/flask-service
      dockerfile: Dockerfile
    container_name: fooddelivery-python-api-1
    environment:
      PORT: 5000
      MONGODB_URI: mongodb://santhosh_db_user:san221155@mongodb:27017/fooddelivery_prod?authSource=admin
      ALLOWED_ORIGIN: http://localhost:3000
    depends_on:
      mongodb:
        condition: service_healthy
    networks:
      - fooddelivery-network
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:5000/healthz" ]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  python-api-2:
    build:
      context: ./backend/flask-service
      dockerfile: Dockerfile
    container_name: fooddelivery-python-api-2
    environment:
      PORT: 5000
      MONGODB_URI: mongodb://santhosh_db_user:san221155@mongodb:27017/fooddelivery_prod?authSource=admin
      ALLOWED_ORIGIN: http://localhost:3000
    depends_on:
      mongodb:
        condition: service_healthy
    networks:
      - fooddelivery-network
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:5000/healthz" ]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # =====================================================
  # Node.js API Gateway Instances (3 replicas)
  # =====================================================
  node-api-1:
    build:
      context: ./backend/node-service
      dockerfile: Dockerfile
    container_name: fooddelivery-node-api-1
    environment:
      PORT: 3000
      NODE_ENV: production
      MONGODB_URI: mongodb://santhosh_db_user:san221155@mongodb:27017/fooddelivery_prod?authSource=admin
      DOWNSTREAM_BASE_URL: http://python-api-1:5000
      JWT_SECRET: your-super-secret-jwt-key-change-in-production-2024
      JWT_EXPIRE: 7d
      CORS_ORIGIN: http://localhost
      USE_CLUSTER: "false"
      NUM_WORKERS: 2
    depends_on:
      mongodb:
        condition: service_healthy
      python-api-1:
        condition: service_healthy
    networks:
      - fooddelivery-network
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:3000/api/health" ]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  node-api-2:
    build:
      context: ./backend/node-service
      dockerfile: Dockerfile
    container_name: fooddelivery-node-api-2
    environment:
      PORT: 3000
      NODE_ENV: production
      MONGODB_URI: mongodb://santhosh_db_user:san221155@mongodb:27017/fooddelivery_prod?authSource=admin
      DOWNSTREAM_BASE_URL: http://python-api-2:5000
      JWT_SECRET: your-super-secret-jwt-key-change-in-production-2024
      JWT_EXPIRE: 7d
      CORS_ORIGIN: http://localhost
      USE_CLUSTER: "false"
      NUM_WORKERS: 2
    depends_on:
      mongodb:
        condition: service_healthy
      python-api-2:
        condition: service_healthy
    networks:
      - fooddelivery-network
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:3000/api/health" ]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  node-api-3:
    build:
      context: ./backend/node-service
      dockerfile: Dockerfile
    container_name: fooddelivery-node-api-3
    environment:
      PORT: 3000
      NODE_ENV: production
      MONGODB_URI: mongodb://santhosh_db_user:san221155@mongodb:27017/fooddelivery_prod?authSource=admin
      DOWNSTREAM_BASE_URL: http://python-api-1:5000
      JWT_SECRET: your-super-secret-jwt-key-change-in-production-2024
      JWT_EXPIRE: 7d
      CORS_ORIGIN: http://localhost
      USE_CLUSTER: "false"
      NUM_WORKERS: 2
    depends_on:
      mongodb:
        condition: service_healthy
      python-api-1:
        condition: service_healthy
    networks:
      - fooddelivery-network
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:3000/api/health" ]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # =====================================================
  # React Frontend
  # =====================================================
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: fooddelivery-frontend
    environment:
      VITE_API_URL: http://localhost/api
    depends_on:
      - node-api-1
      - node-api-2
      - node-api-3
    networks:
      - fooddelivery-network
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:5173" ]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # =====================================================
  # Nginx Load Balancer (reverse proxy)
  # =====================================================
  nginx-lb:
    image: nginx:alpine
    container_name: fooddelivery-nginx-lb
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx-lb.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/html:/usr/share/nginx/html:ro
      # For HTTPS (optional)
      # - ./nginx/certs:/etc/nginx/certs:ro
    depends_on:
      - node-api-1
      - node-api-2
      - node-api-3
      - frontend
    networks:
      - fooddelivery-network
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost/healthz" ]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

# =====================================================
# Networks and Volumes
# =====================================================
networks:
  fooddelivery-network:
    driver: bridge

volumes:
  mongodb_data:
    driver: local
